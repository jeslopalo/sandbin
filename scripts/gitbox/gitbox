#!/usr/bin/env sandbash

source "${SANDBIN_HOME}/scripts/lib/colors.lib.zsh"
source "${SANDBIN_HOME}/scripts/lib/git-functions.lib.zsh"
source "${SANDBIN_HOME}/scripts/gitbox/gitbox.lib.zsh"

function usage() {
    printf "${YELLOW}%s${NORMAL}\n" "usage: gitbox [init [-f]] [setup] [-h | --help]"
}

function gitbox() {

    if [ $# = 0 ]; then
        printf "${RED}%s${NORMAL}\n" "Sorry! I need a command to continue :("
        usage;
        exit 0;
    fi

    while [[ $# > 0 ]];  do
        key="$1"

        case $key in
            init)
                shift
                gitbox-init "$@"
                exit $?
            ;;
            setup)
                shift
                gitbox-setup "$@"
                exit $?
            ;;
            -h|--help)
                usage
                exit 1
            ;;
            *)
                printf "${RED}%s${NORMAL}\n" "Ouch! Unknown option '$key'. Please try agan!"
                usage
                exit 0
            ;;
        esac

        shift;
    done
}

function gitbox-init() {

    while [[ $# > 0 ]]; do
        key="$1"

        case $key in
            -f)
            force=$key
            ;;
            -h|--help)
                usage
                exit 1
            ;;
            *)
            printf "${RED}%s${NORMAL}\n" "Ouch! Unknown option '$key'. Please try agan!"
            usage
            exit 0
            ;;
        esac

        shift;
    done

    if [ -d "./.git" ]; then
        printf "${YELLOW}The '%s' directory is already a git repository!${NORMAL}\n" $(pwd)
    else
        printf "Initializing git in '%s' directory...\n" $(pwd)
        git init
    fi

    printf "Initializing git flow in '%s' directory...\n" $(pwd)
    git flow init $force
}

function gitbox-setup() {

    while [[ $# > 0 ]];  do
        key="$1"

        case $key in
            aliases)
                shift
                gitbox-setup-aliases "$@"
                exit $?
            ;;
            user)
                shift
                gitbox-setup-attribute "user.name" "$@"
                exit $?
            ;;
            email)
                shift
                gitbox-setup-attribute "user.email" "$@"
                exit $?
            ;;
            -h|--help)
                usage
                exit 1
            ;;
            *)
                printf "${RED}%s${NORMAL}\n" "Ouch! Unknown option '$key'. Please try agan!"
                usage
                exit 0
            ;;
        esac

        shift;
    done

    printf "${RED}%s${NORMAL}\n" "Ouch! There is not enough parameters 'gitbox setup [subcommand]'"
    usage
    exit 0
}

function gitbox-setup-aliases-usage() {
    printf "%s\n" "usage: gitbox setup aliases <scope> [-c | --clean-aliases] [aliases file prefix] [-h | --help]"
    printf "\t- ${BOLD}scope:${NORMAL} --system | --global | --local\n"
}

function gitbox-setup-aliases() {

    while [[ $# > 0 ]];  do
        key="$1"

        case $key in
            --system|--global|--local)
                scope=$key
            ;;
            -c|--clean-aliases)
                clean_aliases=$key
            ;;
            -h|--help)
                gitbox-setup-aliases-usage
                return 1
            ;;
            *)
                aliases_file_prefix=$key
            ;;
        esac

        shift;
    done

    if [ ! -d .git ]; then
        printf "${RED}Ouch! I need a git repository to work${NORMAL}\n"
        return 0;
    fi

    if [ -z $scope ]; then
        printf "${RED}Ouch! I need a scope (ie. --system, --global, --local) to setup aliases${NORMAL}\n"
        return 0;
    fi

    if [ ! -z $clean_aliases ]; then
        printf "${YELLOW}Cleaning aliases in %s scope...${NORMAL}\n" "$scope"
        git config $scope --remove-section alias 2> /dev/null
    fi

    if [ -z $aliases_file_prefix ]; then
        aliases_file_prefix="default"
    fi

    source "${SANDBIN_HOME}/dotfiles/gitaliases/${aliases_file_prefix}.gitaliases"
}

function gitbox-setup-attribute-usage() {
    local attribute="$1"
    local scope="$2"

    if [ -z $scope ]; then
        printf "usage: gitbox setup %s <scope> <%s value>\n" "$attribute" "$attribute"
        printf "\t- ${BOLD}scope:${NORMAL} --system | --global | --local\n"
    else
        printf "usage: gitbox setup %s %s <%s value>\n" "$attribute" "$scope" "$attribute"
    fi
}

function gitbox-setup-attribute() {

    local attribute="$1"
    shift;

    while [[ $# > 0 ]];  do
        key="$1"

        case $key in
            -h|--help)
                gitbox-setup-attribute-usage $attribute $scope
                return 1;
            ;;
                --system|--global|--local)
                scope="$1"
            ;;
            *)
                value="$1"
            ;;
        esac
        shift;
    done

    if [ -z $value ] || [ -z $scope ]; then
        printf "${RED}%s${NORMAL}\n" "Ouch! There is not enough parameters."
        gitbox-setup-attribute-usage $attribute $scope
        exit 0
    fi

    set_git_attribute "$attribute" "$scope" "$value"
    printf "${GREEN}Great! '$BOLD%s$NORMAL$GREEN' has been configured as %s in %s scope ${NORMAL}\n" "$(get_git_attribute $attribute $scope)" "$attribute" "$scope"
}

gitbox "$@"